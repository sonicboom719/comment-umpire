# コメント審判 (Comment Umpire)

YouTube動画のコメントを表示・分析するツール集です。AIを使用してコメントを詳細に分析し、19種類のカテゴリーに分類します。

## 概要

YouTube動画のコメントを表示し、AIで個別に分析できるStreamlit Webアプリケーションです。

## 主要機能

### コメント表示・分析機能
- YouTube Data API v3を使用したコメント抽出
- OpenAI APIを使用したリアルタイムコメント分析
- 動画情報の表示（タイトル、チャンネル名、プロフィール画像）
- 返信コメントのインデント表示と文脈を考慮した分析
- 初回100件、追加100件ずつのコメント表示

### AI分析機能
- **19種類のカテゴリー分類**: 皮肉、嘲笑、感想、意見、アドバイス、批判、誹謗中傷、悪口、侮辱、上から目線、論点すり替え、攻撃的、賞賛、感謝、情報提供、問題提起、正論、差別的、共感
- **グラハムの反論ヒエラルキー**: Lv1(罵倒)〜Lv7(主眼論破)による反論の質の評価
- **論理的誤謬の検出**: 対人論証、権威論証、ストローマン論法、お前だって論法、滑り坂論法
- **文脈考慮分析**: 返信コメントでは親コメントと前の返信を文脈として分析
- **複数カテゴリー対応**: 1つのコメントが複数のカテゴリーに該当する場合の処理
- **カスタムプロンプト**: additional_prompt.txtによる分析指示のカスタマイズ

## プロジェクト構造

```
comment_umpire/
├── streamlit_app.py           # Streamlit Webアプリ（メイン）
├── requirements_streamlit.txt # 依存関係
├── core_prompt.txt            # AI分析のコアプロンプト
├── additional_prompt.txt      # AI分析用カスタムプロンプト
├── test_comment_analysis.py   # テストコード
├── run_tests.py              # テスト実行ランナー
├── README_tests.md           # テスト説明書
├── .env                     # APIキー設定（要作成）
├── README.md                # このファイル
└── CLAUDE.md                # Claude Code用設定
```

## セットアップ

### 1. APIキーの取得

#### YouTube Data API v3
1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 新しいプロジェクトを作成または既存のプロジェクトを選択
3. 「APIとサービス」→「ライブラリ」から「YouTube Data API v3」を検索して有効化
4. 「APIとサービス」→「認証情報」でAPIキーを作成

#### OpenAI API
1. [OpenAI Platform](https://platform.openai.com/)にアクセス
2. アカウントを作成またはログイン
3. 「API keys」セクションで新しいAPIキーを作成

### 2. 環境設定

```bash
# .envファイルを作成してAPIキーを設定
# .envファイルに以下を記載：
YOUTUBE_API_KEY=your_youtube_api_key_here
OPENAI_API_KEY=your_openai_api_key_here
```

## Streamlit Webアプリの使用方法

### インストール

```bash
# 依存関係のインストール
pip install -r requirements_streamlit.txt

# アプリの起動
streamlit run streamlit_app.py
```

### 使い方

1. **コメント取得**
   - YouTube URLを入力ボックスに貼り付け
   - 「コメントを取得」ボタンをクリック
   - 動画情報（タイトル、チャンネル名）が表示される
   - 初回100件のコメントが表示される

2. **コメント分析**
   - 各コメントの「⚖️ 審判」ボタンをクリック
   - サイドバーにAI分析結果が表示される
   - 19種類のカテゴリーが色分けされたバッジで表示
   - 反論の場合は グラハムのヒエラルキーレベルを表示
   - 論理的誤謬があれば検出結果を表示

3. **返信コメント**
   - 「▶ X件の返信」ボタンで返信を表示
   - 返信はインデント表示される
   - 返信の分析では親コメントと前の返信が文脈として考慮される

4. **追加読み込み**
   - 「さらに表示」ボタンで追加100件ずつ読み込み

### 分析カスタマイズ

AI分析は2つのプロンプトファイルで構成されています：

#### `core_prompt.txt` (コアプロンプト)
- 基本的な分析指示とカテゴリー定義
- JSON形式の指定
- グラハムのヒエラルキーの定義
- 通常は編集不要

#### `additional_prompt.txt` (追加プロンプト)  
- 特定の分析指示のカスタマイズ
- ユーザーが自由に編集可能

```
# 例：特定のコンテキストを考慮
このコメントはゲーム実況動画に関するものとして分析してください。

# 例：特定の表現への注意
ネタバレや伏せ字を含むコメントに特に注意してください。
```

## テスト機能

コメント分析機能の動作確認のための包括的なテストコードを用意しています。

### テストの実行

```bash
# テストの実行
python run_tests.py

# または直接テストファイルを実行
python test_comment_analysis.py

# pytestが利用可能な場合
pytest test_comment_analysis.py -v
```

### テスト内容

- **19種類の分類カテゴリー**の正常動作確認
- **グラハムのヒエラルキー**7レベル全ての判定テスト
- **論理的誤謬検出**機能のテスト
- **文脈考慮分析**のテスト
- **モック機能**によりAPIを使わずに動作確認可能

詳細は `README_tests.md` を参照してください。


## 分析結果例

### 19種類のカテゴリー分類
```
感想: 32件 (32.0%)    賞賛: 18件 (18.0%)
意見: 15件 (15.0%)    情報提供: 12件 (12.0%)
アドバイス: 8件 (8.0%)  感謝: 6件 (6.0%)
批判: 4件 (4.0%)     問題提起: 3件 (3.0%)
誹謗中傷: 1件 (1.0%)   悪口: 1件 (1.0%)
```

### グラハムのヒエラルキー（反論の質）
```
Lv1: 罵倒: 2件           Lv5: 反論提示: 4件
Lv2: 人格攻撃: 3件        Lv6: 論破: 2件
Lv3: 論調批判: 5件        Lv7: 主眼論破: 1件
Lv4: 単純否定: 8件
```

### 論理的誤謬の検出
```
対人論証: 5件
権威論証: 3件
ストローマン論法: 2件
お前だって論法: 1件
滑り坂論法: 1件
```

### WebアプリでのAI分析表示例

各コメントの「審判」ボタンをクリックすると、サイドバーに以下のような分析結果が表示されます：

- **カテゴリーバッジ**: 該当するカテゴリーが色分けされて表示
- **反論の質**: グラハムのヒエラルキーレベル（該当する場合）
- **論理的誤謬**: 検出された誤謬（該当する場合）
- **判定理由**: AIによる詳細な分析説明

## 注意事項とAPI使用について

### API使用料金
- **YouTube Data API v3**: 無料枠あり（日次クォータ: 10,000ユニット）
- **OpenAI API**: 使用量に応じて料金発生（gpt-4o-miniモデル使用）
- WebアプリでのAI分析は1回につき約0.001〜0.01ドル程度

### 使用上の注意
- リアルタイム分析のため、大量のコメント分析時は費用に注意
- OpenAI APIの使用量制限に注意

## トラブルシューティング

### コメントが取得できない場合
- 動画のコメントが無効になっていないか確認
- APIキーが正しく設定されているか確認（`.env`ファイルの場所と内容）
- YouTube APIのクォータが残っているか確認

### AI分析が失敗する場合
- OpenAI APIキーが正しく設定されているか確認
- インターネット接続を確認
- OpenAI APIの使用量制限を確認

### Webアプリでボタンを2回押す必要がある場合
- ブラウザを再読み込みしてください
- 古いセッション状態が残っている可能性があります

### テストが失敗する場合
- `pip install pytest`でpytestをインストール
- `.env`ファイルにAPIキーが設定されているか確認
- モックテストの場合、APIキーは不要です

## ライセンス

このプロジェクトはMITライセンスで公開されています。